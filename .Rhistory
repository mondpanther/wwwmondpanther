"inETS:manage100"="ETS firm x Above Median CCMI x After 2012",
"phasef1:etsfirm"  = "Base x ETS firm",
"phasef3:etsfirm"  = "Announce x ETS firm",
"phasef4:etsfirm"  = "Implement x ETS firm",
"phasef1:etsfirm:manage100"  = "Base x ETS firm x Well managed",
"phasef3:etsfirm:manage100"  = "Announce x ETS firm x Well managed",
"phasef4:etsfirm:manage100"  = "Implement x ETS firm x Well managed"))
# Chunk 27
#etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1))
etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE)
# Chunk 28
#etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1))
etable(xm1,xm2,xm3,xm4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE,file="pois15.tex",replace=T,style.tex  = style.tex(line.top = "\\toprule", line.bottom = "\\bottomrule",                 tablefoot = FALSE))
etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE,file="pois.tex",replace=T,
style.tex  = style.tex(line.top = "\\toprule", line.bottom = "\\bottomrule",                 tablefoot = FALSE))
# Chunk 29
#etable(xm1,xm2,xm3,xm4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1))
etable(xm1,xm2,xm3,xm4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE)
# Chunk 30
library(haven)
extra=read_dta("https://www.dropbox.com/s/jwopw47288bqlab/ETSscoresForRalf.dta?dl=1")  %>%
right_join(df %>% select(uniqid,etsfirm) %>% distinct(), by="uniqid") %>%
mutate(zets_rational=ifelse( is.na(zets_rational) & etsfirm==0,0,zets_rational),
zets_stringe=ifelse( is.na(zets_stringe) & etsfirm==0,0,zets_stringe)) %>%
mutate(stringe=qs(zets_stringe),rational=qs(zets_rational),anticip=qs(zets_anticip))
table(df$rational)
test =df%>% select(rational ,rationl)
df=df %>% select(-anticip,-rational)
df=df %>% left_join(extra,by="uniqid")
m1=fepois(coal~inETS + inETS:anticip  +inETS:manage    | uniqid+year,    data=df,cluster="uniqid")
summary(m1)
m1=fepois(coal~inETS + inETS:rational +inETS:stringe +inETS:manage  +inETS:qcoal  | uniqid+year,    data=df,cluster="uniqid")
summary(m1)
m1=fepois(coal~inETS + inETS:manage  +inETS:qcoal  | uniqid+year,    data=df,cluster="uniqid")
summary(m1)
#cor(df %>% select(zet))
#m2=fepois(oil   ~inETS + inETS:manage   | year +uniqid,  data=df,cluster="uniqid")
m2=fepois(oil    ~inETS + inETS:manage     | year +uniqid,    data=df,cluster="uniqid")
m3=fepois(elec   ~inETS + inETS:manage     | year +uniqid,    data=df,cluster="uniqid")
m4=fepois(water  ~inETS + inETS:manage     | year +uniqid,    data=df,cluster="uniqid")
obscountby=df %>% filter(coal>0) %>% group_by( manage,etsfirm,year) %>% dplyr::summarize(n(),sum(coal>0),sum(oil>0),sum(elec>0),sum(water>0))
obscountall=df %>% filter(coal>0) %>% group_by( year) %>% dplyr::summarize(All=n(),
`Non zero Coal`=sum(coal>0),
`Non zero Oil` =sum(oil>0),
`Non zero Electricity`=sum(elec>0),
`Non zero Water`=sum(water>0))
kbl(obscountall)
# Chunk 1: setup
knitr::opts_chunk$set(echo = FALSE, message=FALSE,warning=FALSE)
library(haven)
ets = read_dta("https://www.dropbox.com/s/r1e53jhba54xqnm/mcchinadata_forexploration_long.dta?dl=1")
library(dplyr)
# Chunk 2
library(knitr)
#read_chunk("https://www.dropbox.com/s/aic10h7p1dozdr9/prepdata.R?dl=1")
# Chunk 3: prep data
library(tidyr)
library(magrittr)
library(dplyr)
ets %<>% mutate(lnelec=log(m312),
ln1Pelec=log(1+m312),
lncoal=log(m313),
ln1Pcoal=log(1+m313),
lnoil=log(m314),
ln1Poil=log(1+m314),
lnwater=log(m315),
ln1Pwater=log(1+m315),
elec=m312,
coal=m313,
oil=m314,
water=m315) %>%
rowwise() %>% mutate(
zets_anticip=mean(c(zets2017, zets2_stg, zets2_tgh, zauct_allowce, zsanc_stg),na.rm=T))
test=ets %>% select(zets_anticip)
library(readr)
#write_csv(ets,"../../Apps/Overleaf/McChinaETSdata/mcchinadata_forexploration_long.csv")
# Figure out OK obs
ets %<>% group_by(uniqid) %>% arrange(uniqid,year) %>%
mutate(Lelec=dplyr::lag(elec),
okid=((elec>0&!is.na(elec))|
(coal>0&!is.na(coal))|
(oil>0&!is.na(oil))>0) )
#ets= ets %>% filter(elec>0 | (dplyr::lag(elec)==0 & elec==0) )  %>% ungroup()
table(ets$nace)
#test=ets %>% select(okid,lnelec,year,elec,coal,oil,water,uniqid,okid) %>% filter(okid==T)
etsf=ets %>% filter(okid & fp_hubei==0
) %>% group_by(uniqid) %>%
mutate(miny=min(year),maxy=max(year)) %>%
filter( miny<2013 & maxy>=2013 & year<=2015 & year>=2007)
etsf[is.na(etsf)]=NA
#etsf %>% group_by(year) %>% summarize(mean(elec==0),mean(coal==0),n())
test=etsf %>% select(zenvmgt_index_Opt4,zets_anticip,zets_rational,uniqid,year)
etsf=etsf %>% mutate(preid=year<2013,postid=year>=2013)
mmean=function(x)mean(x,na.rm=T)
etsfpre=etsf %>% filter(year<2013) %>% group_by(uniqid,etsfirm) %>%
summarise_at(vars(elec,coal,oil,water,zenvmgt_index_Opt4,zets_anticip,zets_rational),mmean)
grr  =function(x) ifelse(x+dplyr::lag(x)==0,0,(x-dplyr::lag(x))/(x+dplyr::lag(x))*2)
dd=function(x) (x-dplyr::lag(x))
dd1P=function(x) (log(1+x)-log(1+dplyr::lag(x)))
etsby=etsf %>%    group_by(uniqid,preid,etsfirm,nace) %>%
summarise_at(vars(elec,coal,oil,water,year),mmean)     %>%
arrange(uniqid,-preid) %>% group_by(uniqid) %>%
mutate(grcoal=grr(coal),groil=grr(oil),grelec=grr(elec),grwater=grr(water),
ddcoal=dd(coal),ddoil=dd(oil),ddelec=dd(elec),ddwater=dd(water),
dd1Pcoal=dd1P(coal),dd1Poil=dd1P(oil),dd1Pelec=dd1P(elec),dd1Pwater=dd1P(water))
qs=function(x) {
ddd=etsfpre %>% ungroup()
qvar=x#[ddd$etsfirm==1]
cut(x, breaks = c(-1,as.vector(quantile(qvar,probs=c(.5,1) ,na.rm=T))),
labels=c("50","100"))
}
#aaa=quantile(etsfpre$oil,probs=c(.2,.6))
#as.vector(aaa)
#test=etsfpre %>% ungroup() %>%  mutate(tt=qs(oil))
#gg=test %>% filter(tt=="100")
etsfpre=etsfpre %>% ungroup() %>%  mutate(qoil=qs(oil),manage=qs(zenvmgt_index_Opt4),rational=qs(zets_rational), anticip =qs(zets_anticip),
qcoal=qs(coal),
qelec=qs(elec),
qwater=qs(water)) %>%
select(uniqid,qcoal,qelec,qwater,qoil,manage,rational,anticip)
etsf=etsf %>% inner_join(etsfpre,by="uniqid")
# Chunk 4: more data prep
etsbyXpre=etsby %>% inner_join(etsfpre,by="uniqid")
#etsbyX#
etsf=etsf %>% mutate(inETS=(etsfirm==1 & year>=2013 & fp_hubei==0 ) | (etsfirm==1 & year>=2013 &fp_hubei==1 ))
#names(etsf)
#lm(coal~inETS+factor(year),etsf) %>% summary()
library(fixest)
df=etsf %>% select(preid , coal,inETS,uniqid,year,qcoal,qelec,qwater,qoil,oil,elec,water,manage,
rational,anticip,
ends_with("coal"),ends_with("oil") ,ends_with("elec"),
ends_with("water"),
etsfirm)
df=do.call(data.frame,lapply(df, function(x) replace(x, is.infinite(x),NA)))
#df= df %>% mutate()
#df=df %>% filter(qcoal==100)
table(df$year)
df=df %>% group_by(uniqid) %>% mutate(miny=min(year),maxy=max(year),
inETSXtop=inETS*(qcoal=="100"),
inETS=as.numeric(inETS))
df%<>%filter(miny<2013&maxy>=2013)
df%<>%mutate(rationl=ifelse(etsfirm==0,0,rational),rationl=ifelse(anticip==0,0,anticip))
# Chunk 5: prepare descriptive stats
obsdelta=etsbyXpre %>% filter(!is.na(grcoal)) %>%   group_by(etsfirm,manage)  %>% dplyr::summarise(nn=n())
obs=df %>% filter(!is.na(coal)) %>%  group_by(etsfirm,manage) %>% dplyr::summarise(nn=n())
firms=df %>% filter(!is.na(coal)) %>%  distinct(uniqid,.keep_all=T) %>%
group_by(etsfirm,manage) %>% dplyr::summarise(nn=n())
# Chunk 6
set.seed(1206)
q <- data.frame(p = rep(c("A","B"),each = 10,len = 30),
a = rep(c(1,2,3),each = 10),
id = seq(30),
b = round(runif(30,10,20)),
c = round(runif(30,40,70)))
library(tables)
tab <- tabular((Factor(etsfirm)*Factor(manage)+1) ~ (N = 1) + (coal + oil + elec + water) * (mean + sd),
data = etsbyXpre %>% filter(preid))
ttt1=tab[ tab[,1] > 0, ]
library(kableExtra)
library(Hmisc)
tab <- tabular((Factor(etsfirm)*Factor(qcoal)+1) ~ (N = 1) + (coal) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttcoal=tab[ tab[,1] > 0, ]
tab <- tabular((Factor(etsfirm)*Factor(qoil)+1) ~ (N = 1) + (oil) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttoil=tab[ tab[,1] > 0, ]
tab <- tabular((Factor(etsfirm)*Factor(qelec)+1) ~ (N = 1) + (elec) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttelec=tab[ tab[,1] > 0, ]
tab <- tabular((Factor(etsfirm)*Factor(qwater)+1) ~ (N = 1) + (water) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttwater=tab[ tab[,1] > 0, ]
# Chunk 7
toKable(ttt1)
# Chunk 8: with line
#invisible(booktabs())
#toKable(ttt)
# Chunk 9
library(ggplot2)
library(ggridges)
library(gridExtra)
library(grid)
library(png)
#library(downloader)
#library(grDevices)
#library(plyr)
#etsfirm=recode(factor(etsfirm),`0`="non ETS",
#`1`="ETS"),etsfirm=relevel(etsfirm,ref="non ETS"),
etsbyXpre=etsbyXpre %>% mutate(etsfirm=factor(etsfirm))
test=etsbyXpre%>%mutate(      etsfirm=relevel(etsfirm,ref="0"))
etsbyXpre=test %>%   mutate(                 etsfirm=recode(etsfirm,
`0`  = "Non ETS",
`1` = "ETS" ),
manage=recode(manage,
`50`  = "Below Median",
`100` = "Above Median" ))
#etsbyXpre <- within(etsbyXpre, etsfirm <- relevel(etsfirm, ref = "non ETS"))
grpics=function(x,label=""){
etsbyXpre["xxx"]=etsbyXpre[x]
mmn=mean(etsbyXpre$xxx)
mms=as.character(mmn)
etsbyXpre %>%   ggplot() + xlab(label)+ ylab("Management Quality") +
scale_fill_discrete( name = "" , labels=) +
geom_density_ridges(  aes(x = xxx, y=manage,  fill = factor(etsfirm)),alpha=.3,scale=1.1) +
theme_minimal()  + theme(legend.position="bottom")+ annotate("text", x=mmn, y=2, label= mms)
}
p1=grpics("grcoal", label="Growth of Coal")
p2=grpics("groil",  label="Growth of Oil")
p3=grpics("grelec", label="Growth of Electricity")
p4=grpics("grwater",label="Growth of Water")
g_legend<-function(a.gplot){
tmp <- ggplot_gtable(ggplot_build(a.gplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]
return(legend)}
mylegend<-g_legend(p1)
# Chunk 10: densityplots
grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
p2 + theme(legend.position="none"),
p3 + theme(legend.position="none"),
p4 + theme(legend.position="none"),
nrow=2),
mylegend, nrow=2,heights=c(10, 1))
# Chunk 12
library(lmtest)
library(multiwayvcov)
#lm(coal ~  inETS:qcoal + qcoal+factor(etsfirm)+factor(year), ) %>% summary()
#lm(grcoal ~  etsfirm, etsbyXpre %>% filter(qcoal=="100")) %>% summary()
#lm(grcoal ~  etsfirm, etsbyXpre %>% filter(qcoal!="100")) %>% summary()
#lm(grcoal ~  etsfirm*manage, etsbyXpre) %>% summary()
etsbyXpre%<>%group_by(uniqid) %>% mutate(maxcoalid=max(coal)>0)
nozesmatr=function(fuel,x,df){
edf=df  %>% filter((!!as.name(fuel))!=0)
form=paste0(fuel,"~", x)
#feols(fml=form   , data=edf,se="hetero")
ttt=paste0("feols(",form  ,", data=edf,se='hetero')")
eval(parse(text=ttt))
}
m1=nozesmatr("grcoal", "etsfirm",etsbyXpre)
m2=nozesmatr("groil",  "etsfirm",etsbyXpre)
m3=nozesmatr("grelec", "etsfirm",etsbyXpre)
m4=nozesmatr("grwater","etsfirm",etsbyXpre)
# Chunk 13
# write regression table to disk
etable(m1,m2,m3,m4,tex = TRUE, file = "table_etsonly.tex", replace = TRUE, style.tex = style.tex("aer"),
signifCode = NA, fitstat = ~ r2 + n)
#etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1))
# Chunk 15
etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE)
#etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1))
# Chunk 16
#m1=feols(grcoal  ~ etsfirm*manage     ,  data=etsbyXpre,se="hetero")
#m2=feols(groil   ~ etsfirm*manage     ,  data=etsbyXpre,se="hetero")
#m3=feols(grelec  ~ etsfirm*manage     ,  data=etsbyXpre,se="hetero")
#m4=feols(grwater ~ etsfirm*manage     ,  data=etsbyXpre,se="hetero")
etsbyXpre%<>%mutate(eXm=etsfirm=="ETS" & manage=="Above Median")
m1=nozesmatr("grcoal", "etsfirm*manage",etsbyXpre)
m2=nozesmatr("groil",  "etsfirm*manage",etsbyXpre)
m3=nozesmatr("grelec", "etsfirm*manage",etsbyXpre)
m4=nozesmatr("grwater","etsfirm*manage",etsbyXpre)
#m5=nozesmatr("grcoal", "eXm",etsbyXpre)
#summary(m5)
# Chunk 18
etable(m1,m2,m3,m4, signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE)
# Chunk 19
toKable(tttcoal)
toKable(tttoil)
toKable(tttelec)
toKable(tttwater)
# Chunk 20
m1=nozesmatr("grcoal",    "etsfirm*manage + etsfirm*qcoal",etsbyXpre)
m2=nozesmatr("groil",     "etsfirm*manage + etsfirm*qoil",etsbyXpre)
m3=nozesmatr("grelec"  ,  "etsfirm*manage + etsfirm*qelec",etsbyXpre)
m4=nozesmatr("grwater"  , "etsfirm*manage + etsfirm*qwater",etsbyXpre)
# Chunk 21
#etable(m1,m2,m3,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1))
etable(m1,m2,m3,m4,signifCode = c("***" = 0.01, "**" = 0.05,"*"=0.1),tex = TRUE)
# Chunk 22: coalplot
etsbyXpre%<>%group_by(uniqid) %>% arrange(uniqid,-preid) %>%
mutate(Lcoal=dplyr::lag(coal),Lelec=dplyr::lag(elec)) %>%
ungroup()
p1=ggplot(etsbyXpre %>% filter(manage=="Above Median" ),aes(y=groil, x=grcoal, color=factor(etsfirm) ))+
geom_point(alpha=.3,aes(size=Lcoal))+geom_smooth(method=lm)+theme_minimal() +
scale_fill_discrete( name = "") + scale_color_discrete( name = "") +
scale_size_continuous( name = "Amount") +
theme(legend.position="bottom")+ggtitle("Good Management")+
xlab("Arc growth rate of coal")+ylab("Arc growth rate of oil")
p2=ggplot(etsbyXpre %>% filter(manage=="Below Median" ),aes(y=groil, x=grcoal, color=factor(etsfirm) ))+
geom_point(alpha=.3)+geom_smooth(method=lm)+theme_minimal()+ggtitle("Bad Management")+
xlab("Arc growth rate of coal")+ylab("Arc growth rate of oil")
mylegend<-g_legend(p1)
grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
p2 + theme(legend.position="none"),
nrow=1),
mylegend, nrow=2,heights=c(10, 1))
# Chunk 23: elecplot
p1=ggplot(etsbyXpre%>% filter(manage=="Above Median" ) ,aes(y=groil, x=grelec, color=factor(etsfirm) ))+
geom_point(alpha=.3,aes(size=Lelec))+geom_smooth(method=lm)+theme_minimal()+ggtitle("Good Management")+
xlab("Arc growth rate of electricity")+ylab("Arc growth rate of oil")
p2=ggplot(etsbyXpre%>% filter(manage=="Below Median" ) ,aes(y=groil, x=grelec, color=factor(etsfirm) ))+
geom_point(alpha=.3,aes(size=Lelec))+geom_smooth(method=lm)+theme_minimal()+ggtitle("Bad Management")+
xlab("Arc growth rate of electricity")+ylab("Arc growth rate of oil")
grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
p2 + theme(legend.position="none"),
nrow=1),
mylegend, nrow=2,heights=c(10, 1))
#ggplot(etsbyXpre ,aes(y=groil, x=grcoal, color=factor(manage) ))+
#         geom_point()+geom_smooth(method=lm)+theme_minimal()
#ggplot(etsbyXpre ,aes(y=groil, x=grelec, color=factor(manage) ))+
#         geom_point()+geom_smooth(method=lm)+theme_minimal()
#table(etsbyXpre$manage)
#test=etsbyXpre %>% filter(is.na(manage))
knitr::opts_chunk$set(echo = TRUE)
#nuts2=nuts2 %>% left_join(xlook,by=c("geo_code"="NUTS318CD"))
rta=read.csv("rta.csv")
View(rta)
View(rta)
rta=read.csv("https://www.dropbox.com/s/3qyeyrq1a9g0nix/rta.csv?dl=1")
library(plotly)
df <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/2014_world_gdp_with_codes.csv')
df[,2] <- as.numeric(df[,2])
df[,2] <- log(df[,2])
clook=read.csv("https://www.dropbox.com/s/3hb2kol78zgb4h0/ccodelook.csv?dl=1")
df=df %>% left_join(clook,by=c("CODE"="ccode3")) %>% left_join(rta %>% filter(all>0),by="ccode")
shapefile <- readOGR(dsn="../../Clean Growth Report 2017/code/R example/R example", layer = "nuts3_withid")
render_site()
library(distill)
render_site()
# Chunk 1: setup
knitr::opts_chunk$set(echo = FALSE, message=FALSE,warning=FALSE)
library(haven)
ets = read_dta("https://www.dropbox.com/s/r1e53jhba54xqnm/mcchinadata_forexploration_long.dta?dl=1")
library(dplyr)
# Chunk 2
library(knitr)
#read_chunk("https://www.dropbox.com/s/aic10h7p1dozdr9/prepdata.R?dl=1")
# Chunk 3: prep data
library(tidyr)
library(magrittr)
library(dplyr)
ets %<>% mutate(lnelec=log(m312),
ln1Pelec=log(1+m312),
lncoal=log(m313),
ln1Pcoal=log(1+m313),
lnoil=log(m314),
ln1Poil=log(1+m314),
lnwater=log(m315),
ln1Pwater=log(1+m315),
elec=m312,
coal=m313,
oil=m314,
water=m315) %>%
rowwise() %>% mutate(
zets_anticip=mean(c(zets2017, zets2_stg, zets2_tgh, zauct_allowce, zsanc_stg),na.rm=T))
test=ets %>% select(zets_anticip)
library(readr)
#write_csv(ets,"../../Apps/Overleaf/McChinaETSdata/mcchinadata_forexploration_long.csv")
# Figure out OK obs
ets %<>% group_by(uniqid) %>% arrange(uniqid,year) %>%
mutate(Lelec=dplyr::lag(elec),
okid=((elec>0&!is.na(elec))|
(coal>0&!is.na(coal))|
(oil>0&!is.na(oil))>0) )
#ets= ets %>% filter(elec>0 | (dplyr::lag(elec)==0 & elec==0) )  %>% ungroup()
table(ets$nace)
#test=ets %>% select(okid,lnelec,year,elec,coal,oil,water,uniqid,okid) %>% filter(okid==T)
etsf=ets %>% filter(okid & fp_hubei==0
) %>% group_by(uniqid) %>%
mutate(miny=min(year),maxy=max(year)) %>%
filter( miny<2013 & maxy>=2013 & year<=2015 & year>=2007)
etsf[is.na(etsf)]=NA
#etsf %>% group_by(year) %>% summarize(mean(elec==0),mean(coal==0),n())
test=etsf %>% select(zenvmgt_index_Opt4,zets_anticip,zets_rational,uniqid,year)
etsf=etsf %>% mutate(preid=year<2013,postid=year>=2013)
mmean=function(x)mean(x,na.rm=T)
etsfpre=etsf %>% filter(year<2013) %>% group_by(uniqid,etsfirm) %>%
summarise_at(vars(elec,coal,oil,water,zenvmgt_index_Opt4,zets_anticip,zets_rational),mmean)
grr  =function(x) ifelse(x+dplyr::lag(x)==0,0,(x-dplyr::lag(x))/(x+dplyr::lag(x))*2)
dd=function(x) (x-dplyr::lag(x))
dd1P=function(x) (log(1+x)-log(1+dplyr::lag(x)))
etsby=etsf %>%    group_by(uniqid,preid,etsfirm,nace) %>%
summarise_at(vars(elec,coal,oil,water,year),mmean)     %>%
arrange(uniqid,-preid) %>% group_by(uniqid) %>%
mutate(grcoal=grr(coal),groil=grr(oil),grelec=grr(elec),grwater=grr(water),
ddcoal=dd(coal),ddoil=dd(oil),ddelec=dd(elec),ddwater=dd(water),
dd1Pcoal=dd1P(coal),dd1Poil=dd1P(oil),dd1Pelec=dd1P(elec),dd1Pwater=dd1P(water))
qs=function(x) {
ddd=etsfpre %>% ungroup()
qvar=x#[ddd$etsfirm==1]
cut(x, breaks = c(-1,as.vector(quantile(qvar,probs=c(.5,1) ,na.rm=T))),
labels=c("50","100"))
}
#aaa=quantile(etsfpre$oil,probs=c(.2,.6))
#as.vector(aaa)
#test=etsfpre %>% ungroup() %>%  mutate(tt=qs(oil))
#gg=test %>% filter(tt=="100")
etsfpre=etsfpre %>% ungroup() %>%  mutate(qoil=qs(oil),manage=qs(zenvmgt_index_Opt4),rational=qs(zets_rational), anticip =qs(zets_anticip),
qcoal=qs(coal),
qelec=qs(elec),
qwater=qs(water)) %>%
select(uniqid,qcoal,qelec,qwater,qoil,manage,rational,anticip)
etsf=etsf %>% inner_join(etsfpre,by="uniqid")
etsbyXpre=etsby %>% inner_join(etsfpre,by="uniqid")
#etsbyX#
etsf=etsf %>% mutate(inETS=(etsfirm==1 & year>=2013 & fp_hubei==0 ) | (etsfirm==1 & year>=2013 &fp_hubei==1 ))
#names(etsf)
#lm(coal~inETS+factor(year),etsf) %>% summary()
library(fixest)
df=etsf %>% select(preid , coal,inETS,uniqid,year,qcoal,qelec,qwater,qoil,oil,elec,water,manage,
rational,anticip,
ends_with("coal"),ends_with("oil") ,ends_with("elec"),
ends_with("water"),
etsfirm)
df=do.call(data.frame,lapply(df, function(x) replace(x, is.infinite(x),NA)))
#df= df %>% mutate()
#df=df %>% filter(qcoal==100)
table(df$year)
df=df %>% group_by(uniqid) %>% mutate(miny=min(year),maxy=max(year),
inETSXtop=inETS*(qcoal=="100"),
inETS=as.numeric(inETS))
df%<>%filter(miny<2013&maxy>=2013)
df%<>%mutate(rationl=ifelse(etsfirm==0,0,rational),rationl=ifelse(anticip==0,0,anticip))
obsdelta=etsbyXpre %>% filter(!is.na(grcoal)) %>%   group_by(etsfirm,manage)  %>% dplyr::summarise(nn=n())
obs=df %>% filter(!is.na(coal)) %>%  group_by(etsfirm,manage) %>% dplyr::summarise(nn=n())
firms=df %>% filter(!is.na(coal)) %>%  distinct(uniqid,.keep_all=T) %>%
group_by(etsfirm,manage) %>% dplyr::summarise(nn=n())
set.seed(1206)
q <- data.frame(p = rep(c("A","B"),each = 10,len = 30),
a = rep(c(1,2,3),each = 10),
id = seq(30),
b = round(runif(30,10,20)),
c = round(runif(30,40,70)))
library(tables)
tab <- tabular((Factor(etsfirm)*Factor(manage)+1) ~ (N = 1) + (coal + oil + elec + water) * (mean + sd),
data = etsbyXpre %>% filter(preid))
ttt1=tab[ tab[,1] > 0, ]
library(kableExtra)
library(Hmisc)
dtable=function(fuel){
#fuel="coal"
qfuel=paste0("q",fuel)
nn=paste("n",fuel)
nm=paste("m",fuel)
ff=etsbyXpre   %>%
group_by(etsfirm,!!sym(qfuel)) %>%
summarise( n=n(),
m=mean(!!sym(fuel)) )
}
res=dtable("coal") %>% rename(ncoal=n,mcoal=m)
res=bind_cols(res,dtable("oil")  %>% rename(noil=n,moil=m))
res=bind_cols(res,dtable("elec") %>% rename(nelec=n,melec=m))
res=bind_cols(res,dtable("water") %>% rename(nwater=n,mwater=m))
tab <- tabular((Factor(etsfirm)*Factor(qcoal)+1) ~ (N = 1) + (coal) * (mean + sd)
data = etsbyXpre %>% filter(preid))
tttcoal=tab[ tab[,1] > 0, ]
tab <- tabular((Factor(etsfirm)*Factor(qoil)+1) ~ (N = 1) + (oil) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttoil=tab[ tab[,1] > 0, ]
tab <- tabular((Factor(etsfirm)*Factor(qelec)+1) ~ (N = 1) + (elec) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttelec=tab[ tab[,1] > 0, ]
tab <- tabular((Factor(etsfirm)*Factor(qwater)+1) ~ (N = 1) + (water) * (mean + sd),
data = etsbyXpre %>% filter(preid))
tttwater=tab[ tab[,1] > 0, ]
library(ggplot2)
library(ggridges)
library(gridExtra)
library(grid)
library(png)
#library(downloader)
#library(grDevices)
#library(plyr)
#etsfirm=recode(factor(etsfirm),`0`="non ETS",
#`1`="ETS"),etsfirm=relevel(etsfirm,ref="non ETS"),
etsbyXpre=etsbyXpre %>% mutate(etsfirm=factor(etsfirm))
test=etsbyXpre%>%mutate(      etsfirm=relevel(etsfirm,ref="0"))
etsbyXpre=test %>%   mutate(                 etsfirm=recode(etsfirm,
`0`  = "Non ETS",
`1` = "ETS" ),
manage=recode(manage,
`50`  = "Below Median",
`100` = "Above Median" ))
#etsbyXpre <- within(etsbyXpre, etsfirm <- relevel(etsfirm, ref = "non ETS"))
grpics=function(x,label=""){
etsbyXpre["xxx"]=etsbyXpre[x]
mmn=mean(etsbyXpre$xxx)
mms=as.character(mmn)
etsbyXpre %>%   ggplot() + xlab(label)+ ylab("Management Quality") +
scale_fill_discrete( name = "" , labels=) +
geom_density_ridges(  aes(x = xxx, y=manage,  fill = factor(etsfirm)),alpha=.3,scale=1.1) +
theme_minimal()  + theme(legend.position="bottom")+ annotate("text", x=mmn, y=2, label= mms)
}
p1=grpics("grcoal", label="Growth of Coal")
p2=grpics("groil",  label="Growth of Oil")
p3=grpics("grelec", label="Growth of Electricity")
p4=grpics("grwater",label="Growth of Water")
g_legend<-function(a.gplot){
tmp <- ggplot_gtable(ggplot_build(a.gplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]
return(legend)}
mylegend<-g_legend(p1)
grid.arrange(arrangeGrob(p1 + theme(legend.position="none"),
p2 + theme(legend.position="none"),
p3 + theme(legend.position="none"),
p4 + theme(legend.position="none"),
nrow=2),
mylegend, nrow=2,heights=c(10, 1))
create_post("etschina")
library(distill)
create_post("etschina")
create_post("cleanrta")
