---
title: "Powbal India - Spring 23 Dashboard"
output: html_document
date: "2023-03-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE,warning=FALSE)
knitr::opts_knit$set(root.dir="C:/Users/rmartin/OneDrive - Imperial College London/powbal_india/code")
#setwd("C:/Users/rmartin/OneDrive - Imperial College London/powbal_india/code")


```



```{r}
#| echo: false
#| message: false
#| warning: False

library(dbplyr)
library(dplyr)
library(RSQLite)
library(readr)
library(lubridate)
library(readxl)
library(kableExtra)





```

Last update `r now()`

This page provides basic statistics and information on the POWBAL PAUSE Demand Pilot in India.

```{r settings, echo=FALSE,message=FALSE}
#| echo: false
#| message: false
#| warning: False


  #timepoint="2019-05-1 5:00:00"   
  timepoint=as_datetime(now())-hours(1)
  # we examine performance in the 2 weeks preceeding
  end=as_datetime(timepoint)
  start   = as_datetime(end) - weeks(2)  # 2 week period
  unistart= as_date("2022-08-01")        # start of the universe (when the overall trial started)

```

```{r}
#| echo: false
#| message: false
#| warning: False


library(fst)
library(arrow)

energyx=read_feather("../data/energydata_india.arrow")

ok_usersx=read_feather("../data/userdata_india.feather")

ok_usersx=ok_usersx%>% ungroup() %>%
          arrange(date_joined)%>% filter(date_joined>unistart) %>%
          mutate(cumusers=1:n(),date_joined=as_date(date_joined),type="App") 
library(dplyr)

mida=min(ok_usersx$date_joined)

usersonline=energyx %>% group_by(email) %>% mutate(nzpower=ifelse(power==0,NA,power)) %>% 
            summarise(date_joined=min(timestamp), 
                      maxpower=max(power,na.rm=T),meanpower=mean(power,na.rm=T),
                      meannzpower=mean(nzpower,na.rm=T)) %>% 
                      ungroup() %>% arrange(date_joined) %>% filter(date_joined>mida) %>%
            mutate(cumusers=1:n(), type="Plug",date_joined=as_date(date_joined)) 


uu=bind_rows(ok_usersx,usersonline)




```

### Registered users over time

In total we have `r nrow(ok_usersx)` who registered with the POWBAL app since summer 2022. `r nrow(usersonline)` also succesfully configured a plug that came online at some point.

```{r}
#| echo: false
#| message: false
#| warning: False


library(ggplot2)
uu %>% ggplot(aes(x=date_joined,y=cumusers,color=type))+geom_line()+theme_minimal() + scale_x_date(date_labels = "%b/%y") +xlab("")+ylab("Number of users")+scale_color_discrete(name="")


```

### Distribution of Power consumption

Most participating household connect fairly power hungry devices to the plugs at least some of the time. The Figure below shows the distribution of maximum power connected across plugs. This average at `r round(mean(usersonline$maxpower,na.rm=T))` Watt. Note that the distribution is bimodal. There is a concentration of users at below 1kWh. However, there is also a fairly big mass above 2kWh. Users in that range must have connected a fairly substantial air-conditioning unit or similar.

Mean power consumption is naturally much lower and highly concentrated near 0. That said: for some users even the unconditional average is above 1kW; i.e. they are connecting an air conditioning unit or similar in most periods.

```{r}
#| echo: false
#| message: false
#| warning: False


library(tidyverse)
library(hrbrthemes)
library(viridis)


p1=usersonline %>% ggplot( aes( x=maxpower)) + ggtitle("Maximum Power")+
  geom_density(color="red") + 
  theme_minimal()+xlab("Power in Watt")+ylab("Density")


p2=usersonline %>% ggplot( aes( x=meanpower)) + ggtitle("Mean Power")+
  geom_density(color="blue") + 
  theme_minimal()+xlab("Power in Watt")+ylab("Density")


p3=usersonline %>% ggplot( aes( x=meannzpower)) + ggtitle("Mean Power>0")+
  geom_density(color="blue") + 
  theme_minimal()+xlab("Power in Watt")+ylab("Density")



library(ggpubr)


#ggarrange(p1, p2, p3, ncol=3, nrow=1, common.legend = TRUE, legend="bottom")
ggarrange(p1, p2, p3, ncol=3, nrow=1)

```

### Basic time series - A bird's eye view on the whole pilot trial.....

```{r timeseries}
#| echo: false
#| message: false
#| warning: False


    #total=energy %>% filter(power<100)
    #total=energyall %>% mutate(power=ifelse(is.na(power),0,power))
    total=energyx %>% mutate(power=ifelse(is.na(power),0,power)) #%>%
       #filter(timestamp>start)
    
    
    #summary(total$power)
    
    
    
    total$hour=round_date(ymd_hms(total$timestamp),"hours")
    
    
    total <- total %>%
      dplyr::group_by(hour,device_id) %>%
      dplyr::mutate(nn = 1:n())
    total=mutate(total, plugs=nn==1)
    
    
    
    
    #total=total %>% mutate(power=ifelse(is.na(power),0,power))
    
    
    
    total=total %>% dplyr::group_by( hour) %>% dplyr::summarise(Wh = sum(power*5/60) , count=sum(plugs) ) 
    
    #max(total$hour)
    
    
    total=total%>%filter(as_datetime(hour)>as_datetime("2022-01-01")) %>% 
          mutate(ihour=with_tz(hour, tzone = "Asia/Calcutta")) 
  

    
    #total=total%>%filter(as_datetime(hour)<=as_datetime(timepoint))
    
    total_old=total
    #total=total[total$count<500,]
    
    library(ggplot2)
    
    
    p <- ggplot(total, aes(x = hour))
    p <- p + geom_line(aes(y = Wh, colour = "Power Consumption"))
    #p
    
    # adding the relative humidity data, transformed to match roughly the range of the temperature
    scaler=max(total$Wh)/max(total$count)
    
    
    p <- p + geom_line(aes(y = count*scaler, colour = "Plugs online"))
    
    # now adding the secondary axis, following the example in the help file ?scale_y_continuous
    # and, very important, reverting the above transformation
    p <- p + scale_y_continuous(sec.axis = sec_axis(~./scaler, name = "Number of plugs online"))
    
    
    
    # modifying colours and theme options
    p <- p + scale_colour_manual(values = c("blue", "red"))
    p <- p + labs(y = "Power Consumption in Wh",
                  x = "Time",
                  colour = "Series")
    p <- p + theme(legend.position = c(0.8, 0.9))+theme_minimal()
    #p
    

    #filename=paste0("OneDrive - Imperial College London/powbal/data/lotterydata/consumption",dd,".png")
    #ggsave(filename, plot = last_plot(), device = NULL, path = NULL,
    #       scale = 1, width = 15, height = 15, units = c("cm"),
    #       dpi = 300, limitsize = FALSE)
    #filename=paste0("C:/Users/rmartin/Dropbox/POWBAL/WWW/consumption","latest",".png")
    #ggsave(filename, plot = last_plot(), device = NULL, path = NULL,
    #       scale = 1, width = 30, height = 9, units = c("cm"),
    #       dpi = 700, limitsize = FALSE)
    
    



```

#### Plugs Connected:

```{r, fig.width=6, fig.height=5}
#| echo: false
#| message: false
#| warning: false


library(dygraphs)
library(xts)          # To make the convertion data-frame / xts format
library(tidyverse)
library(lubridate)

    don = xts(x = total$count, order.by = total$ihour)

# Finally the plot
p <- dygraph(don) %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors="blue") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)

p


```

#### Energy consumed (Wh):

```{r , fig.width=6, fig.height=5}
#| echo: false
#| message: false
#| warning: false


    don = xts(x = total$Wh, order.by = total$ihour)

# Finally the plot
p <- dygraph(don) %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors="red") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1)

p



```

### Hours of the day

Average figures by hour of the day. This gives us an idea if users are providing more shifting potential by the hour of the day.

```{r hour of day}
#| echo: false
#| message: false
#| warning: false
#| eval: false

library(fixest)
#grep("Calcutta", OlsonNames(), value=TRUE)
energyx=energyx %>% 
  mutate(indiatime=with_tz(timestamp, tzone = "Asia/Calcutta")) %>% 
  mutate(hour=hour(indiatime))


r1  =  feols(power~0+factor(hour),energyx)
r1 %>% summary()

ids=energyx %>% select(device_id) %>% distinct()

```

```{r }
#| echo: false
#| message: false
#| warning: false

total=total  %>% mutate(hourofd=hour(ihour))

#power_by_hour=energyx %>% 
#  group_by(hour) %>%
#  summarise(power=mean(power,na.rm=T))  %>% inner_join(
#    energyx %>% group_by(timestamp,hour) %>% 
#     summarize(devices=n(),sumpower=sum(power,na.rm=T)) %>% 
#      mutate(avpower=sumpower/devices) %>% 
#      group_by(hour) %>%
#      summarise(devices=mean(devices),sumpower=mean(sumpower),avpower=mean(avpower)) 
#  )


totalbyhour=total %>% group_by(hour,hourofd) %>% summarise(devices=sum(count),sumpower=sum(Wh),avpower=sumpower/devices) %>% 
  group_by(hourofd) %>% summarise(devices=mean(devices),sumpower=mean(sumpower),avpower=mean(avpower)) 

#test=energyx %>% filter(is.na(hour))


#power_by_hour %>% ggplot(aes(x=hour,y=power))    +geom_line()

p1=totalbyhour %>% ggplot(aes(x=hourofd,y=devices))  +geom_line()+
  ggtitle("Number of Devices")+xlab("Hour of day")+ylab("Devices")

p2=totalbyhour %>% ggplot(aes(x=hourofd,y=sumpower)) +geom_line()+
  ggtitle("Total power")+xlab("Hour of day")+ylab("Watt")

p3=totalbyhour %>% ggplot(aes(x=hourofd,y=avpower))  +geom_line()+
  ggtitle("Average power")+xlab("Hour of day")+ylab("Watt")


ggarrange(p1, p2, p3, ncol=3, nrow=1)

```



### The anatomy of switch off events.....

The figure below shows the distribution of power consumed as a switch off event progresses. 

```{r}
#| echo: false
#| message: false
#| warning: false

  library(ggridges)


  energyx=energyx %>%  mutate(across(c('lpower','power'), ~ifelse(is.nan(.x)|is.na(.x), 0,.x)))

  
  sos = energyx %>% group_by(email)   %>% mutate(groff=ifelse( soevent==0 & lead(soevent)==1, lead(off) , off) ) %>%  group_by(email,groff) %>%  filter(soevent==1 | lead(soevent)==1)
  
  sosnz=sos  %>% mutate(timediff=difftime(timestamp,off[2],units="mins")) %>% filter(!is.na(timediff)&timediff>=-5) %>% mutate(tt=timediff,timediff=as.factor(as.integer(timediff)),yy=timediff+10) %>% 
     group_by(email,groff)  %>% 
        mutate(maxlpower=max(power,na.rm=T)) %>% filter(maxlpower>0) %>% ungroup()

  
library(ggplot2)  
#ggplot(  sosnz ,aes(x = power) ) +     geom_density() 
          #theme(legend.position = "none")
          
          
          #summary(sosnz$hour)


 ggplot(  sosnz,aes(x = power, y = timediff , color=timediff, fill=timediff) ) +
     geom_density_ridges() +
     theme_ridges() + 
     theme(legend.position = "none") + ylab("Minutes since start of switch off")+xlab("Power in Watt connected to plug")
 
 
 
 eventsnz=sosnz %>% distinct(off)
 events=sos %>% distinct(off)

```

We see that most switch off events are successful; i.e. users typically do not override. This is based on `r  nrow(eventsnz)` events across all users with non zero consumption at the start of the event. 
In total we had `r  nrow(events)`  switch off events across online plugs.


### Virtual power plant capacity factors

Below we compute the capacity factor of our implicit virtual power plant; i.e. across all switch off events we calculate - by switch off duration - what fraction of potential implied power generation has been realised. We see that this amounts to over 80% for the whole duraction of our 30 minute switch offs (note that the data is discretized at the level of 5 minute intervals)


```{r}
#| echo: false
#| message: false
#| warning: false

capfac=sosnz %>% filter(!is.na(off)) %>% group_by(tt) %>%  summarize(maxpower=sum(maxlpower), power=sum(power)) %>% mutate(capfac=100-power/maxpower*100) %>% ungroup()


capfac %>% ggplot(aes(x=tt,y=capfac)) + geom_line(color="blue",size=1.5)+theme_minimal()+xlab("Minutes of switch off")+ylab("Capacity Factor in %")


```


